// This tells Prisma which database type to use
datasource db {
  provider = "postgresql"
  // Note: URL is now configured in prisma.config.ts
}

// This tells Prisma to generate a JavaScript/TypeScript client
generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

// ============================================
// ENUMS
// ============================================

// Odds display format preference
// - AMERICAN: +150, -110 (US style)
// - DECIMAL: 2.50, 1.91 (European style)
// - FRACTIONAL: 3/2, 10/11 (UK style)
enum OddsFormat {
  AMERICAN
  DECIMAL
  FRACTIONAL
}

// Date display format preference
// - US: MM/DD/YYYY (e.g., 01/25/2026)
// - EU: DD/MM/YYYY (e.g., 25/01/2026)
enum DateFormat {
  US
  EU
}

// Temperature unit preference
// - FAHRENHEIT: °F (US style)
// - CELSIUS: °C (International style)
enum TemperatureUnit {
  FAHRENHEIT
  CELSIUS
}

// Defines the allowed context types for notes
// These map to the categories users can tag notes with:
//   - team: Team-related research (e.g., Arsenal form analysis)
//   - fixture: Match-specific notes (e.g., Arsenal vs Chelsea preview)
//   - player: Player-focused research (e.g., Haaland goal patterns)
//   - league: League/competition notes (e.g., Premier League trends)
//   - betting: Betting strategy/system notes (e.g., BTTS research)
//   - general: Uncategorized notes
enum ContextType {
  team
  fixture
  player
  league
  betting
  general
}

// ============================================
// MODELS
// ============================================

// Our User table
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ============================================
  // USER PREFERENCES
  // ============================================
  // Odds format: how betting odds are displayed
  // Default: AMERICAN (US-style odds like +150, -110)
  oddsFormat  OddsFormat @default(AMERICAN)

  // Timezone: IANA timezone string (e.g., "America/New_York")
  // Used for displaying match times in user's local time
  // Default: Eastern Time (US)
  timezone    String     @default("America/New_York")

  // Date format: how dates are displayed
  // Default: US (MM/DD/YYYY)
  dateFormat  DateFormat @default(US) @map("date_format")

  // Temperature unit: how temperatures are displayed
  // Default: FAHRENHEIT (US style)
  temperatureUnit TemperatureUnit @default(FAHRENHEIT) @map("temperature_unit")

  // ============================================
  // ACCOUNT RECOVERY (Optional)
  // ============================================
  // Security question for backup account recovery
  // (in case user can't access their email)
  securityQuestion  String?   // e.g., "What was your first pet's name?"
  securityAnswer    String?   // Hashed answer (like password)

  // ============================================
  // ADMIN ACCESS
  // ============================================
  // Admin users can access protected endpoints like /admin/types/sync
  // Default is false - admins must be manually promoted via database
  isAdmin     Boolean   @default(false) @map("is_admin")

  // ============================================
  // RELATIONSHIPS
  // ============================================
  // A user can have many notes
  notes     Note[]
  
  // A user can have many password reset requests
  passwordResets PasswordReset[]
}

// Our Note table
model Note {
  id          String      @id @default(uuid())
  title       String
  content     String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relationship: Each note belongs to one user
  userId      String
  user        User        @relation(fields: [userId], references: [id])

  // Relationship: A note can have many context links
  links       NoteLink[]
}

// Junction table: Links notes to multiple contexts (teams, fixtures, etc.)
model NoteLink {
  id          String      @id @default(uuid())
  noteId      String
  note        Note        @relation(fields: [noteId], references: [id], onDelete: Cascade)
  contextType ContextType
  contextId   String      // SportsMonks ID (empty string for general/category-only)
  label       String?     // Human-readable name (e.g., "Arsenal" instead of just "19")
  isPrimary   Boolean     @default(false)
  createdAt   DateTime    @default(now())

  // Ensure a note doesn't link to the same context twice
  @@unique([noteId, contextType, contextId])
}

// ============================================
// PASSWORD RESET
// ============================================
// Stores password reset tokens for email-based account recovery.
// Tokens are hashed (like passwords) for security.
// Each token can only be used once and expires after 1 hour.
model PasswordReset {
  id          String    @id @default(uuid())
  
  // The user requesting the password reset
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // The reset token (hashed for security)
  // The unhashed token is sent to the user's email
  token       String
  
  // When this token expires (typically 1 hour from creation)
  expiresAt   DateTime
  
  // Whether this token has been used
  // Once used, it cannot be used again
  used        Boolean   @default(false)
  
  // Timestamps
  createdAt   DateTime  @default(now())
}

// ============================================
// SPORTSMONKS TYPES (Reference/Lookup Data)
// ============================================
// Stores all SportsMonks type definitions locally.
// This follows SportsMonks best practice: fetch types once and store locally
// instead of including .type on every API call.
//
// Types are used throughout the SportsMonks API to identify:
// - Event types (Goal, Yellow Card, Substitution)
// - Statistic types (Corners, Shots On Target, Possession)
// - Injury/suspension types (Hamstring Injury, Red Card Suspension)
// - Position types (Goalkeeper, Midfielder, Centre Back)
// - Prediction types (BTTS Probability, Over/Under)
// - And many more categories...
//
// The 'id' field uses SportsMonks' ID (not auto-generated) so we can
// directly look up types by the IDs returned from API responses.
model SportsMonksType {
  // SportsMonks type ID (NOT auto-generated - we use their IDs)
  id            Int       @id

  // Parent type ID for hierarchical relationships
  // Example: "Hamstring Injury" (id: 535) has parentId: 629 ("Injury")
  parentId      Int?      @map("parent_id")

  // Human-readable name (e.g., "Shots On Target")
  name          String

  // Kebab-case code (e.g., "shots-on-target")
  code          String

  // UPPER_SNAKE_CASE constant (e.g., "SHOTS_ON_TARGET")
  developerName String    @map("developer_name")

  // Category this type belongs to:
  // event, statistic, injury_suspension, position, prediction,
  // standings, standing_rule, period, referee, lineup, metadata,
  // stage_type, sub_event, tie_breaker_rule, timeline, transfer, highlight
  modelType     String    @map("model_type")

  // Sub-grouping within modelType (nullable)
  // Examples: "goals", "cards", "subs" for events
  //           "offensive", "defensive" for statistics
  group         String?

  // Statistical grouping for standings/stats (nullable)
  // Values: "overall", "home", "away", "offensive", "defensive"
  statGroup     String?   @map("stat_group")

  // When this type was last synced from SportsMonks
  lastSyncedAt  DateTime  @default(now()) @map("last_synced_at")

  // Self-referencing relationship for parent/child hierarchy
  parent        SportsMonksType?  @relation("TypeHierarchy", fields: [parentId], references: [id])
  children      SportsMonksType[] @relation("TypeHierarchy")

  // Indexes for fast lookups
  @@index([modelType])
  @@index([code])
  @@index([developerName])

  // Use snake_case table name (PostgreSQL convention)
  @@map("sportsmonks_types")
}